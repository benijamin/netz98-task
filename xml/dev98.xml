<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	
	xmlns:georss="http://www.georss.org/georss"
	xmlns:geo="http://www.w3.org/2003/01/geo/wgs84_pos#"
	>

<channel>
	<title>dev98</title>
	<atom:link href="https://dev98.de/feed/" rel="self" type="application/rss+xml" />
	<link>https://dev98.de</link>
	<description>a blog of the netz98 developer team</description>
	<lastBuildDate>Wed, 19 Jun 2019 09:38:02 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	

<image>
	<url>https://i0.wp.com/dev98.de/wp-content/uploads/2017/03/cropped-logo_50px.png?fit=32%2C32&#038;ssl=1</url>
	<title>dev98</title>
	<link>https://dev98.de</link>
	<width>32</width>
	<height>32</height>
</image> 
<site xmlns="com-wordpress:feed-additions:1">114892074</site>	<item>
		<title>Request data through a proxy with GuzzleHttp &#8211; PSR-7 compliant</title>
		<link>https://dev98.de/2019/06/19/request-data-through-a-proxy-with-guzzlehttp-psr-7-compliant/</link>
				<comments>https://dev98.de/2019/06/19/request-data-through-a-proxy-with-guzzlehttp-psr-7-compliant/#respond</comments>
				<pubDate>Wed, 19 Jun 2019 09:26:09 +0000</pubDate>
		<dc:creator><![CDATA[Elias Henrich]]></dc:creator>
				<category><![CDATA[General]]></category>
		<category><![CDATA[GuzzleHttp]]></category>
		<category><![CDATA[HTTP]]></category>
		<category><![CDATA[magento2]]></category>
		<category><![CDATA[proxy]]></category>
		<category><![CDATA[PSR]]></category>
		<category><![CDATA[PSR-7]]></category>

		<guid isPermaLink="false">https://dev98.de/?p=1104</guid>
				<description><![CDATA[When a Magento shop &#8211; or any other PHP application &#8211; is required to request data from or transmit data to a remote server, it is often necessary to redirect the traffic through a Http-proxy server. In my case this was essential because the called endpoint allows only certain IP addresses to access the requested ressource. Since I am working from various locations, each having a different IP address, I had to find a way that certain Http-requests are routed...<p class="read-more"><a class="btn btn-default" href="https://dev98.de/2019/06/19/request-data-through-a-proxy-with-guzzlehttp-psr-7-compliant/"> Read More<span class="screen-reader-text">  Read More</span></a></p>]]></description>
								<content:encoded><![CDATA[
<p>When a Magento shop &#8211; or any other PHP application &#8211; is required to request data from or transmit data to a remote server, it is often necessary to redirect the traffic through a Http-proxy server. In my case this was essential because the called endpoint allows only certain IP addresses to access the requested ressource. Since I am working from various locations, each having a different IP address, I had to find a way that certain Http-requests are routed through the company&#8217;s proxy server. This article is going to describe what a proxy actually does for us, why I cannot and should not use PHP&#8217;s environment variables and what the best solution is for scenarios where PSR-7 / <a href="http://docs.php-http.org/en/latest/">PHP-Http</a> in combination with <a href="http://docs.guzzlephp.org/en/stable/" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">GuzzleHttp</a> might be.</p>



<h3>What about <a href="https://www.php-fig.org/psr/psr-15/" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">PSR-15</a>?</h3>



<p>Good point! This text will discuss Http middleware components on client side with the example of adding proxy configurations to a request. The relatively new PSR-15 standard handles the server side and focuses mainly on manipulating the response which is sent back to the calling host. Nevertheless you will get a lot of useful information from the <a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://www.php-fig.org/psr/psr-15/" target="_blank">standard</a> and the <a href="https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-15-request-handlers-meta.md#why-doesnt-request-handler-use-__invoke" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">explanation</a>. </p>



<h3>Why don&#8217;t you simply use the the HTTP_PROXY environment variable?</h3>



<p>Guzzle indeed accesses the PHP environment variable HTTP_PROXY and routes every request through the specified proxy, if this value is actually configured in php.ini or by using the <code>setenv()</code>-command. <em>But</em> for security reasons this feature is only available when the script is called from the shell (checked using method <a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://php.net/manual/en/function.php-sapi-name.php" target="_blank">php_sapi_name()</a>). More information on the vulnerability and the reason why GuzzleHttp declines to use the settings from environment variables can be found at <a href="https://httpoxy.org/" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">httpoxy.org</a>. </p>



<h3>GuzzleHttp offers a proxy-configuration within the request()-method &#8211; why not use this?</h3>



<p>Because it it not PSR-7 compliant! The HTTP message interface simply does not provide a method with name <code>request</code> that allows the developer to pass an options-array in which we could add our proxy-configuration. Instead the <a href="https://github.com/php-http/httplug/blob/v1.1.0/src/HttpClient.php" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">interface</a> does only declare a method <code>sendRequest</code> that accepts an object of type <code>\Psr\Http\Message\RequestInterface</code> which also does not offer any proxy configuration. </p>



<h2>Middleware and Handlers</h2>



<p>Middleware components are a powerful &#8211; and PSR-7 compliant &#8211; way to manipulate Http requests before they&#8217;re sent to a remote server. </p>



<p>In an example scenario where it would be required to send authentication data in each server call, it&#8217;d sure be exhausting to update the credentials for each method call all over your application&#8217;s code. Adding a middleware layer that automatically adds the necessary data to each request, before it is transmitted, will reduce the code lines to be updated to just a single one (maybe two).</p>



<p>A middleware is simply a method that resides between the command for sending a request and the actual transmittion. It allows to add, remove or modify data, the target-URL or any other property of the <code>\Psr\Http\Message\RequestInterface</code> as well as additional configuration, that is important for data transfer. </p>



<p>More information on the PSR-7 standard is given in our <a href="https://dev98.de/2017/01/17/psr-7-standard-part1-overview/">in-depth series</a>.</p>



<h3>Create a middleware and add it to the HandlerStack</h3>



<p>The diagram below sketches on the top half the classical way of sending a request: The developer adds a a <code>sendRequest</code> command along with the connection and data settings hold by  <code>$request</code> and passes it to a various transmittion mechanism, e.g. GuzzleHttp.</p>



<figure class="wp-block-image"><img data-attachment-id="1105" data-permalink="https://dev98.de/2019/06/19/request-data-through-a-proxy-with-guzzlehttp-psr-7-compliant/middleware/" data-orig-file="https://i0.wp.com/dev98.de/wp-content/uploads/2019/06/Middleware.png?fit=721%2C239&amp;ssl=1" data-orig-size="721,239" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Middleware" data-image-description="" data-medium-file="https://i0.wp.com/dev98.de/wp-content/uploads/2019/06/Middleware.png?fit=300%2C99&amp;ssl=1" data-large-file="https://i0.wp.com/dev98.de/wp-content/uploads/2019/06/Middleware.png?fit=640%2C212&amp;ssl=1" src="https://i0.wp.com/dev98.de/wp-content/uploads/2019/06/Middleware.png?w=640&#038;ssl=1" alt="" class="wp-image-1105" srcset="https://i0.wp.com/dev98.de/wp-content/uploads/2019/06/Middleware.png?w=721&amp;ssl=1 721w, https://i0.wp.com/dev98.de/wp-content/uploads/2019/06/Middleware.png?resize=300%2C99&amp;ssl=1 300w, https://i0.wp.com/dev98.de/wp-content/uploads/2019/06/Middleware.png?resize=604%2C200&amp;ssl=1 604w" sizes="(max-width: 640px) 100vw, 640px" data-recalc-dims="1" /></figure>



<p>In the bottom half of the diagram two sample middleware methods <code>m1</code> and <code>m2</code> are added to stack that resides between sending the request and the actual transmittion. Both methods are free to modify the request or the configuration hold by <code>$options</code> and are executed one after another, as described by the <em>chain of responsibility</em>, part of the infamous <a href="https://en.wikipedia.org/wiki/Design_Patterns" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">Gang of Four</a>.</p>



<p>The following implementation has proven to be stable but might be a bit more complex than what is actually necessary to create a middleware method. The reason for that is because of a better test-ability and more flexibility for future add-ons. </p>



<h3>Class ProxyMiddleware</h3>



<p>First step is to create a new class called <code>ProxyMiddleware</code> that is responsible to prepare the concrete middleware method for the handler stack, managed by GuzzleHttp. This class has static method, which holds the proxy settings (URL and port) and will return a closure that will be pushed onto the handler stack later.</p>



<pre class="wp-block-preformatted">public static function getProxyMiddleware($serverUrl): callable
{
 &nbsp; &nbsp;self::$proxyUrl = $serverUrl;
​
 &nbsp; &nbsp;return function (callable $handler) {
 &nbsp; &nbsp; &nbsp; &nbsp;return new ProxyMiddleware($handler);
 &nbsp;  };
}</pre>



<p>As soon as the closure is called during data transmittion a new instance of the <code>ProxyMiddleware</code>-class is created and invoked by the stack dispatcher. Therefore we need to implement the actual middleware-call inside of the magic <code>__invoke</code>-method:</p>



<pre class="wp-block-preformatted">public function __invoke(RequestInterface $request, array $options)<br>{<br> &nbsp; &nbsp;$fn = $this-&gt;nextHandler;<br>​<br> &nbsp; &nbsp;$options['proxy'] = [<br> &nbsp; &nbsp; &nbsp; &nbsp;'http' &nbsp;=&gt; self::$proxyUrl,<br> &nbsp; &nbsp; &nbsp; &nbsp;'https' =&gt; self::$proxyUrl,<br> &nbsp;  ];<br>​<br> &nbsp; &nbsp;return $fn($request, $options);<br>}</pre>



<p>It&#8217;s that simple! We just add the proxy information to the <code>$options</code>-array and pass the new information onto the method described by <code>$nextHandler</code>. That was easy!</p>



<h3>Add our middleware to the handler stack</h3>



<p>After we have created the middleware handler, we need to tell GuzzleHttp to actually execute it after the <code>sendRequest</code>-command is executed. For this second step we need to instantiate a new <code>HandlerStack</code>-object using the class&#8217; static <code>create</code>-method.</p>



<pre class="wp-block-preformatted">$handlerStack = \GuzzleHttp\HandlerStack::create();<br>$handlerStack-&gt;push(ProxyMiddleware::getProxyMiddleware('proxy_url'), 'middleware_id');<br>​<br>$options['handler'] = $handlerStack;<br>​<br>$httpClient = \Http\Adapter\Guzzle6\Client::createWithConfig($options);</pre>



<p>Now we simply push the previously described closure onto the stack together with an identifier-string. Allthough this ID is optional, it will be more than helpful for debugging your application, since Guzzle adds a couple of default middlewares to the stack and you would end up in a unmanageable mess. </p>



<p>After we have created and configured the handler stack, we simply use the static <code>createWithConfig</code>-method that allows us to inject a options-array into the instantiation of a new Guzzle PSR-7 compliant Http client. </p>



<p>From now on, all requests that are sent using this Http client will be transmitted with your middleware executed inbetween and having the proxy setting configured!</p>



<h2>Caveat: Unit Testing</h2>



<p>Testing your new middleware-class might be a little bit tricky. I just want you to know that closures, like the class member <code>$nextHandler</code> can be mocked using PHP&#8217;s pre-defined core class  <a href="https://www.php.net/manual/de/reserved.classes.php" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">\stdClass</a> and the magic <code>__invoke</code> method. In case you&#8217;re using PHPUnit, the following snippet might be helpful:</p>



<pre class="wp-block-preformatted">$nextHandlerMock = $this-&gt;createPartialMock(\stdClass::class, ['__invoke']);</pre>



<h2>More information</h2>



<ul><li><a href="https://dev98.de/2017/01/17/psr-7-standard-part1-overview/">https://dev98.de/2017/01/17/psr-7-standard-part1-overview/</a></li><li><a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="http://docs.guzzlephp.org/en/stable/handlers-and-middleware.html" target="_blank">http://docs.guzzlephp.org/en/stable/handlers-and-middleware.html</a></li><li><a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="http://docs.guzzlephp.org/en/stable/request-options.html#proxy" target="_blank">http://docs.guzzlephp.org/en/stable/request-options.html#proxy</a></li><li><a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://medium.com/@brad_brothers/build-a-better-api-client-with-guzzle-middleware-2ace56868dc7" target="_blank">https://medium.com/@brad_brothers/build-a-better-api-client-with-guzzle-middleware-2ace56868dc7</a></li><li><a href="https://github.com/darrenmothersele/php-psr7-proxy" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">https://github.com/darrenmothersele/php-psr7-proxy</a></li></ul>
]]></content:encoded>
							<wfw:commentRss>https://dev98.de/2019/06/19/request-data-through-a-proxy-with-guzzlehttp-psr-7-compliant/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">1104</post-id>	</item>
		<item>
		<title>A visit at our friends of Atwix in Lviv/Ukraine</title>
		<link>https://dev98.de/2019/04/10/a-visit-at-our-friends-of-atwix-in-lviv-ukraine/</link>
				<comments>https://dev98.de/2019/04/10/a-visit-at-our-friends-of-atwix-in-lviv-ukraine/#respond</comments>
				<pubDate>Wed, 10 Apr 2019 15:38:03 +0000</pubDate>
		<dc:creator><![CDATA[Christian Münch]]></dc:creator>
				<category><![CDATA[General]]></category>

		<guid isPermaLink="false">https://dev98.de/?p=1061</guid>
				<description><![CDATA[Last month we received an invitation by our friends of Atwix to attend their Barcamp in Lviv/Ukraine. My colleague Oleksandr and me were happy to join it. Oleksandr was the perfect mate, because he was grown up in Ukraine and so he knows everything about the traditions and local specialities. Our journey started in Frankfurt. After a stopover in Munich we arrived on site with enough energy to explore the beautiful city of Lviv. Oleksandr introduced me to the local...<p class="read-more"><a class="btn btn-default" href="https://dev98.de/2019/04/10/a-visit-at-our-friends-of-atwix-in-lviv-ukraine/"> Read More<span class="screen-reader-text">  Read More</span></a></p>]]></description>
								<content:encoded><![CDATA[
<p>Last month we received an invitation by our friends of Atwix to attend their Barcamp in Lviv/Ukraine. My colleague Oleksandr and me were happy to join it. Oleksandr was the perfect mate, because he was grown up in Ukraine and so he knows everything about the traditions and local specialities.</p>



<p>Our journey started in Frankfurt. After a stopover in Munich we arrived on site with enough energy to explore the beautiful city of Lviv. <br>Oleksandr introduced me to the local delicacies like Borsch (Борщ), Blini (млинці) with Cherry and Varenyky (вареники).</p>



<figure class="wp-block-image"><img data-attachment-id="1062" data-permalink="https://dev98.de/2019/04/10/a-visit-at-our-friends-of-atwix-in-lviv-ukraine/img_20190314_153444/" data-orig-file="https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/IMG_20190314_153444.jpg?fit=1707%2C1280&amp;ssl=1" data-orig-size="1707,1280" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="IMG_20190314_153444" data-image-description="" data-medium-file="https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/IMG_20190314_153444.jpg?fit=300%2C225&amp;ssl=1" data-large-file="https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/IMG_20190314_153444.jpg?fit=640%2C480&amp;ssl=1" src="https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/IMG_20190314_153444.jpg?fit=640%2C480&amp;ssl=1" alt="" class="wp-image-1062" srcset="https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/IMG_20190314_153444.jpg?w=1707&amp;ssl=1 1707w, https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/IMG_20190314_153444.jpg?resize=300%2C225&amp;ssl=1 300w, https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/IMG_20190314_153444.jpg?resize=768%2C576&amp;ssl=1 768w, https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/IMG_20190314_153444.jpg?resize=1024%2C768&amp;ssl=1 1024w, https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/IMG_20190314_153444.jpg?resize=360%2C270&amp;ssl=1 360w, https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/IMG_20190314_153444.jpg?w=1280&amp;ssl=1 1280w" sizes="(max-width: 640px) 100vw, 640px" /><figcaption>Traditional Ukraine Food<br></figcaption></figure>



<p>After an delicious meal we met among others Slava Kravchuk (CEO of Atwix), Yaroslav, Maria Zayak, Tomislav Bilić (CEO of Inchoo) and Max Yekaterynenko (Director of Community Engineering at Adobe). </p>



<h2>Barcamp</h2>



<p>The Barcamp started with a breakfast where the attendees already had the chance to get to know each other.</p>



<p>The agenda of the Barcamp was created in different way compared to previous Barcamps I attended. There were two parallel tracks with already defined talks and discussions. I had the honor to have a talk about Gitlab CI Build Pipelines. </p>



<figure class="wp-block-image"><img data-attachment-id="1065" data-permalink="https://dev98.de/2019/04/10/a-visit-at-our-friends-of-atwix-in-lviv-ukraine/atwix-barcamp-agenda/" data-orig-file="https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/Atwix-Barcamp-Agenda.png?fit=800%2C450&amp;ssl=1" data-orig-size="800,450" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Atwix-Barcamp-Agenda" data-image-description="" data-medium-file="https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/Atwix-Barcamp-Agenda.png?fit=300%2C169&amp;ssl=1" data-large-file="https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/Atwix-Barcamp-Agenda.png?fit=640%2C360&amp;ssl=1" src="https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/Atwix-Barcamp-Agenda.png?w=640&#038;ssl=1" alt="" class="wp-image-1065" srcset="https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/Atwix-Barcamp-Agenda.png?w=800&amp;ssl=1 800w, https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/Atwix-Barcamp-Agenda.png?resize=300%2C169&amp;ssl=1 300w, https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/Atwix-Barcamp-Agenda.png?resize=768%2C432&amp;ssl=1 768w, https://i2.wp.com/dev98.de/wp-content/uploads/2019/04/Atwix-Barcamp-Agenda.png?resize=480%2C270&amp;ssl=1 480w" sizes="(max-width: 640px) 100vw, 640px" data-recalc-dims="1" /><figcaption>Agenda</figcaption></figure>



<p>As you can see, there were a lot of interesting talks about all the hot Magento stuff like PWA. Also non Magento related topics like Remote Working were part of the agenda.</p>



<figure class="wp-block-embed-twitter wp-block-embed is-type-rich is-provider-twitter"><div class="wp-block-embed__wrapper">
<blockquote class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">The legendary <a href="https://twitter.com/cmuench?ref_src=twsrc%5Etfw">@cmuench</a> from <a href="https://twitter.com/netz98?ref_src=twsrc%5Etfw">@netz98</a> is explaining the intelligent pipelines and <a href="https://twitter.com/hashtag/Magento?src=hash&amp;ref_src=twsrc%5Etfw">#Magento</a> deployment process at the <a href="https://twitter.com/atwixcom?ref_src=twsrc%5Etfw">@atwixcom</a> barcamp <a href="https://twitter.com/hashtag/atwixbarcamp?src=hash&amp;ref_src=twsrc%5Etfw">#atwixbarcamp</a> <a href="https://t.co/Ha5lVsX0EF">pic.twitter.com/Ha5lVsX0EF</a></p>&mdash; Slava Kravchuk (@slkra) <a href="https://twitter.com/slkra/status/1106496003459465222?ref_src=twsrc%5Etfw">March 15, 2019</a></blockquote><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div></figure>



<p>After a long day with a lot of good content and discussions the day ended with a party at a very cool <a href="https://www.fest.lviv.ua/uk/restaurants/kryjivka/">location</a> where we tasted local food and drinks together with the Atwix and Inchoo guys.</p>



<h2>Magento Contribution Day</h2>



<p>Atwix as No. 1 Contributor had organized a Magento Contribution Day. A Contribution Day is a good chance to dive into the source code of the Magento Core.</p>



<p>The procedure is very easy. Pick some topics from Magento Contribution backlog and try to fix, solve or invent stuff. If you do not know what you can do, visit the portal to start your way to contribute.</p>



<p><a href="https://opensource.magento.com/">https://opensource.magento.com/</a></p>



<p>It is also possible to contribute to non code related topics like the developer documentation. I personally picked up an old bug ticket which was not edited since 2016.</p>



<h2>Conclusion</h2>



<p>We had a lot of good discussions with <a href="https://www.atwix.com/">Atwix</a> and <a href="https://inchoo.net/">Inchoo</a> developers and project managers about PWA, Magento, Certification and a lot of more topics. I was able to share some insights about Gitlab-CI pipelines which shows the netz98 way of building projects.<br>The evening event was great. The Contribution Day, too&#8230;</p>



<p>Thank you for the hospitality. See you next time in Lviv.</p>



<figure class="wp-block-embed-twitter wp-block-embed is-type-rich is-provider-twitter"><div class="wp-block-embed__wrapper">
<blockquote class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">Thanks so much for the great <a href="https://twitter.com/hashtag/atwixbarcamp?src=hash&amp;ref_src=twsrc%5Etfw">#atwixbarcamp</a> everyone! <a href="https://t.co/pWhZSqrNoY">pic.twitter.com/pWhZSqrNoY</a></p>&mdash; Atwix (@atwixcom) <a href="https://twitter.com/atwixcom/status/1106600934950555648?ref_src=twsrc%5Etfw">March 15, 2019</a></blockquote><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div></figure>
]]></content:encoded>
							<wfw:commentRss>https://dev98.de/2019/04/10/a-visit-at-our-friends-of-atwix-in-lviv-ukraine/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">1061</post-id>	</item>
		<item>
		<title>How a wrong carrier implementation causes a server outage</title>
		<link>https://dev98.de/2018/07/23/how-a-wrong-carrier-implementation-causes-a-server-outage/</link>
				<comments>https://dev98.de/2018/07/23/how-a-wrong-carrier-implementation-causes-a-server-outage/#comments</comments>
				<pubDate>Mon, 23 Jul 2018 08:00:26 +0000</pubDate>
		<dc:creator><![CDATA[Alexander Dite]]></dc:creator>
				<category><![CDATA[Magento 2]]></category>
		<category><![CDATA[performance]]></category>

		<guid isPermaLink="false">https://dev98.de/?p=998</guid>
				<description><![CDATA[Sometimes one wrong line of code can break your site. In the following I will describe a mistake in a Magento 2 custom carrier implementation, which causes a massive overloading of server resources (CPU, RAM, DB processes) and even can cause an outage of your Magento store. The one line of code The following line of code is the reason for the problems, if used in the collectRates() method, or in methods, called from collectRates() in the Carrier class: [crayon-5e244ec5c9e13978845292/]...<p class="read-more"><a class="btn btn-default" href="https://dev98.de/2018/07/23/how-a-wrong-carrier-implementation-causes-a-server-outage/"> Read More<span class="screen-reader-text">  Read More</span></a></p>]]></description>
								<content:encoded><![CDATA[<p>Sometimes one wrong line of code can break your site. In the following I will describe a mistake in a Magento 2 custom carrier implementation, which causes a massive overloading of server resources (CPU, RAM, DB processes) and even can cause an outage of your Magento store.</p>
<h3>The one line of code</h3>
<p>The following line of code is the reason for the problems, if used in the collectRates() method, or in methods, called from collectRates() in the Carrier class:</p><pre class="crayon-plain-tag">$quote = $this-&gt;checkoutSession-&gt;getQuote();</pre><p>So, in other words, you must not obtain the quote object globally via the checkout session.</p>
<h3>The reason</h3>
<p>The method <em>\Magento\Checkout\Model\Session::getQuote(), </em>called for the first time, triggers loading the quote. If we then look at the method <em>\Magento\Quote\Model\Quote::_afterLoad()</em> :</p><pre class="crayon-plain-tag">/**
     * Trigger collect totals after loading, if required
     *
     * @return $this
     */
    protected function _afterLoad()
    {
        // collect totals and save me, if required
        if (1 == $this-&gt;getTriggerRecollect()) {
            $this-&gt;collectTotals()-&gt;save();
            $this-&gt;setTriggerRecollect(0);
        }
        return parent::_afterLoad();
    }</pre><p>We then can see, that for quotes, having the field (also a DB column) <em>trigger_recollect</em> set to 1, <em>collectTotals()</em> method is called.</p>
<p>An attentive reader will already notice, what is going wrong here. It&#8217;s an infinite loop! <em>Quote::collectTotals()</em> will trigger shipping carriers&#8217; method <em>collectRates() </em>and thats where the loop is closed.</p>
<p>The <em>trigger_recollect</em> flag is set in Magento:</p>
<ul>
<li>for quotes depending on catalog price rules</li>
<li>for quotes containing products which were updated (e.g. in Admin or via API)</li>
</ul>
<p>In my case there were a lot of such kind of quotes because of frequent product updates.</p>
<p>The result was overloaded CPUs, RAM, full MySQL process list and several outages as the infinite loops were being executed for the value of seconds equals PHP max_execution_time.</p>
<h3>How to avoid this</h3>
<p>The shipping carrier&#8217;s method collectRates() gets the object of the class <em>\Magento\Quote\Model\Quote\Address\RateRequest </em>passed, where the already loaded quote object should be obtained from (if needed). Unfortunately there is no method &#8220;getQuote()&#8221; in the RateRequest class. The following snippet shows an example of obtaining the quote correctly:</p><pre class="crayon-plain-tag">/**
         * Do not use checkoutSession-&gt;getQuote()!!! it will cause infinite loop for
         * quotes with trigger_recollect = 1, see Quote::_afterLoad()
         */
        $items = $request-&gt;getAllItems();
        if (empty($items)) {
            return false;
        }

        /** @var \Magento\Quote\Model\Quote\Item $firstItem */
        $firstItem = reset($items);
        if (!$firstItem) {
            return false;
        }

        $quote = $firstItem-&gt;getQuote();
        if (!($quote instanceof \Magento\Quote\Model\Quote)) {
            return false;
        }</pre><p>I hope this post can save some nerves for you and your team. Feel free to leave a comment.</p>
]]></content:encoded>
							<wfw:commentRss>https://dev98.de/2018/07/23/how-a-wrong-carrier-implementation-causes-a-server-outage/feed/</wfw:commentRss>
		<slash:comments>1</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">998</post-id>	</item>
		<item>
		<title>How to avoid security issues in Composer dependencies</title>
		<link>https://dev98.de/2018/01/24/how-to-avoid-security-issues-in-composer-dependencies/</link>
				<comments>https://dev98.de/2018/01/24/how-to-avoid-security-issues-in-composer-dependencies/#respond</comments>
				<pubDate>Wed, 24 Jan 2018 09:09:46 +0000</pubDate>
		<dc:creator><![CDATA[Christoph Frenes]]></dc:creator>
				<category><![CDATA[General]]></category>
		<category><![CDATA[composer]]></category>
		<category><![CDATA[security]]></category>
		<category><![CDATA[versioning]]></category>

		<guid isPermaLink="false">https://dev98.de/?p=951</guid>
				<description><![CDATA[Composer is a great tool for requiring third party modules and software packages for your project. It’s an essential part of the current Magento 2 project structure. Because of the possibility to add more and more modules it is also getting more and more difficult to keep track of relevant security updates. That is especially the case when required modules have further requirements. Here are 3 tips how to improve your project’s security 1. Subscription of third party repositories (when...<p class="read-more"><a class="btn btn-default" href="https://dev98.de/2018/01/24/how-to-avoid-security-issues-in-composer-dependencies/"> Read More<span class="screen-reader-text">  Read More</span></a></p>]]></description>
								<content:encoded><![CDATA[<p><a href="https://getcomposer.org/">Composer</a> is a great tool for requiring third party modules and software packages for your project. It’s an essential part of the current Magento 2 project structure.</p>
<p>Because of the possibility to add more and more modules it is also getting more and more difficult to keep track of relevant security updates. That is especially the case when required modules have further requirements.</p>
<h3>Here are 3 tips how to improve your project’s security</h3>
<h2>1. Subscription of third party repositories (when using sticky version numbers)</h2>
<p>If the applied module is published on Github you can subscribe to the repository. Github then informs you via email about changes of the code. If the email contains relevant information regarding security issues, the version of the required module can be increased in your project‘s composer.json file. For updating you just have to type:</p><pre class="crayon-plain-tag">composer update vendor/module</pre><p></p>
<h2><img data-attachment-id="954" data-permalink="https://dev98.de/2018/01/24/how-to-avoid-security-issues-in-composer-dependencies/subscribe/" data-orig-file="https://i0.wp.com/dev98.de/wp-content/uploads/2018/01/subscribe.jpg?fit=993%2C225&amp;ssl=1" data-orig-size="993,225" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Subscribing @ Github" data-image-description="" data-medium-file="https://i0.wp.com/dev98.de/wp-content/uploads/2018/01/subscribe.jpg?fit=300%2C68&amp;ssl=1" data-large-file="https://i0.wp.com/dev98.de/wp-content/uploads/2018/01/subscribe.jpg?fit=640%2C145&amp;ssl=1" class="alignnone size-full wp-image-954" src="https://i0.wp.com/dev98.de/wp-content/uploads/2018/01/subscribe.jpg?resize=640%2C145&#038;ssl=1" alt="Subscribing @ Github" width="640" height="145" data-recalc-dims="1" /></h2>
<h2>2. Avoid static version numbers</h2>
<p>Compared to option 1 it would be much more safe to manage the applied parts and the own project via <a href="https://semver.org/">semantic versioning</a>. In those cases you can define the dependencies as follows:</p><pre class="crayon-plain-tag">composer require vendor/module=~3.1</pre><p>In this specific case you would get all versions between 3.1.0 and 3.2.0 by executing a &#8220;composer update&#8221;. If the vendor fixes the module, he just increases the version number at the third position and the new code will be applied and implemented with the next update.</p>
<p>If the vendor implements a new feature however, he increases the major or minor version, e.g. 3.2.x or 4.0.x. The code will only be applied by a manual action of a developer. Reviewing the code before committing the new version would be highly recommended.</p>
<h2>3. Use SensioLabs Scanner</h2>
<p>While option 2 is already a very cool and flexible solution, the developers of the vendors of the applied modules still need to be informed about the security issues and they need to fix them. But the moment they release a new version might be too late. As a developer, you definitely want to know about issues immediately, to disable or replace the dangerous module.</p>
<p>SensioLabs – creator of the Symfony framework – created a <a href="https://security.sensiolabs.org/">database</a> containing known security issues of several packages (Magento, Shopware, Zend Framework etc.) and they allow you to get these information via an <a href="https://security.sensiolabs.org/api">api</a> or a <a href="https://github.com/sensiolabs/security-checker">cli client</a>. These tools scan a given composer.lock file. For every current commit or tag they check for an entry inside the database. After processing the file you get a list of findings if there were any.</p>
<p><img data-attachment-id="961" data-permalink="https://dev98.de/2018/01/24/how-to-avoid-security-issues-in-composer-dependencies/sec_success/" data-orig-file="https://i2.wp.com/dev98.de/wp-content/uploads/2018/01/sec_success.jpg?fit=590%2C223&amp;ssl=1" data-orig-size="590,223" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Security Check: Success" data-image-description="" data-medium-file="https://i2.wp.com/dev98.de/wp-content/uploads/2018/01/sec_success.jpg?fit=300%2C113&amp;ssl=1" data-large-file="https://i2.wp.com/dev98.de/wp-content/uploads/2018/01/sec_success.jpg?fit=590%2C223&amp;ssl=1" class="alignnone size-full wp-image-961" src="https://i2.wp.com/dev98.de/wp-content/uploads/2018/01/sec_success.jpg?resize=590%2C223&#038;ssl=1" alt="Security Check: Success" width="590" height="223" data-recalc-dims="1" /></p>
<p><img data-attachment-id="960" data-permalink="https://dev98.de/2018/01/24/how-to-avoid-security-issues-in-composer-dependencies/sec_error/" data-orig-file="https://i0.wp.com/dev98.de/wp-content/uploads/2018/01/sec_error.jpg?fit=947%2C481&amp;ssl=1" data-orig-size="947,481" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Security Check: Error" data-image-description="" data-medium-file="https://i0.wp.com/dev98.de/wp-content/uploads/2018/01/sec_error.jpg?fit=300%2C152&amp;ssl=1" data-large-file="https://i0.wp.com/dev98.de/wp-content/uploads/2018/01/sec_error.jpg?fit=640%2C325&amp;ssl=1" class="alignnone size-full wp-image-960" src="https://i0.wp.com/dev98.de/wp-content/uploads/2018/01/sec_error.jpg?resize=640%2C325&#038;ssl=1" alt="Security Check: Error" width="640" height="325" data-recalc-dims="1" /></p>
<p>The client can be easily installed via Composer.</p><pre class="crayon-plain-tag">composer require sensiolabs/security-checker</pre><p>Depending on your project and your required Symfony dependencies you might need to use a specific version of the tool.</p>
<p>To run it, all you have to type is:</p><pre class="crayon-plain-tag">vendor/bin/security-checker security:check</pre><p>By today there’s only one entry for Magento 2 in this database:</p>
<ul>
<li><a style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;" href="https://security.sensiolabs.org/database?package=magento/magento2ce">https://security.sensiolabs.org/database?package=magento/magento2ce</a></li>
</ul>
<p>&nbsp;</p>
<h3>Links</h3>
<ul>
<li>SensioLabs security issue database: <a href="https://security.sensiolabs.org/">https://security.sensiolabs.org/</a></li>
<li>SensioLabs security scanner: <a href="https://github.com/sensiolabs/security-checker">https://github.com/sensiolabs/security-checker</a></li>
<li>Semantic versioning: <a href="https://semver.org/">https://semver.org/</a></li>
</ul>
]]></content:encoded>
							<wfw:commentRss>https://dev98.de/2018/01/24/how-to-avoid-security-issues-in-composer-dependencies/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">951</post-id>	</item>
		<item>
		<title>PSR-7 Standard  &#8211; Part 6 &#8211; Server Requests</title>
		<link>https://dev98.de/2018/01/02/psr-7-standard-part-6-server-requests/</link>
				<comments>https://dev98.de/2018/01/02/psr-7-standard-part-6-server-requests/#respond</comments>
				<pubDate>Tue, 02 Jan 2018 00:47:23 +0000</pubDate>
		<dc:creator><![CDATA[Christian Münch]]></dc:creator>
				<category><![CDATA[General]]></category>
		<category><![CDATA[Cookie]]></category>
		<category><![CDATA[Get]]></category>
		<category><![CDATA[Post]]></category>
		<category><![CDATA[PSR]]></category>
		<category><![CDATA[Server]]></category>
		<category><![CDATA[ServerRequest]]></category>

		<guid isPermaLink="false">https://dev98.de/?p=924</guid>
				<description><![CDATA[This post is part of series: Part 1: Overview Part 2: Request and URI Part 3: Response Part 4: File Uploads Part 5: HTTP-Client Part 6: Server Request Part 7: Middleware Part 8: Usage in a Magento module In Part 3 we already discovered the RequestInterface which is used on client side. In this part, we have a more detailed look on the server side. The Server Request inherits all methods of the RequestInterface and has 13 additional methods. Six methods are available to...<p class="read-more"><a class="btn btn-default" href="https://dev98.de/2018/01/02/psr-7-standard-part-6-server-requests/"> Read More<span class="screen-reader-text">  Read More</span></a></p>]]></description>
								<content:encoded><![CDATA[<p>This post is part of series:</p>
<ul>
<li><a href="/2017/01/17/psr-7-standard-part1-overview/">Part 1: Overview</a></li>
<li><a href="https://dev98.de/2017/07/03/psr-7-standard-part-2-request-and-uri/">Part 2: Request and URI</a></li>
<li><a href="https://dev98.de/2017/10/19/psr-7-standard-part-3-response/">Part 3: Response</a></li>
<li><a href="/2017/11/25/psr-7-standard-part-4-file-uploads/">Part 4: File Uploads</a></li>
<li><a href="/2017/12/27/psr-7-standard-part-5-http-client/">Part 5: HTTP-Client</a></li>
<li><strong>Part 6: Server Request</strong></li>
<li>Part 7: Middleware</li>
<li>Part 8: Usage in a Magento module</li>
</ul>
<hr />
<p>In Part 3 we already discovered the <code>RequestInterface</code> which is used on client side. In this part, we have a more detailed look on the server side.</p>
<p><img data-attachment-id="921" data-permalink="https://dev98.de/2018/01/02/psr-7-standard-part-6-server-requests/psr7_server_request-png/" data-orig-file="https://i0.wp.com/dev98.de/wp-content/uploads/2018/01/psr7_server_request.png?fit=3375%2C1785&amp;ssl=1" data-orig-size="3375,1785" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="" data-image-description="" data-medium-file="https://i0.wp.com/dev98.de/wp-content/uploads/2018/01/psr7_server_request.png?fit=300%2C159&amp;ssl=1" data-large-file="https://i0.wp.com/dev98.de/wp-content/uploads/2018/01/psr7_server_request.png?fit=640%2C338&amp;ssl=1" class="alignnone size-full wp-image-921" src="https://i0.wp.com/dev98.de/wp-content/uploads/2018/01/psr7_server_request.png?resize=640%2C338&#038;ssl=1" width="640" height="338" data-recalc-dims="1" /></p>
<p>The Server Request inherits all methods of the <code>RequestInterface</code> and has 13 additional methods. Six methods are available to setup the request object:</p>
<ul>
<li>withCookieParams</li>
<li>withQueryParams</li>
<li>withUploadedFiles</li>
<li>withParsedBody</li>
<li>withAttribute</li>
<li>withoutAttribute</li>
</ul>
<p>Like on client side we have to be careful. The Server Request is designed to be immutable (see Part 3). If we look in the code of the <strong>Guzzle\Psr7 </strong> implementation of the Server Request, we can see that all this methods are needed to create complete request from all global variables</p>
<p>($_SERVER, $_COOKIE, $_GET, $_POST, $_FILES) which we will get from PHP.</p><pre class="crayon-plain-tag">/**
  * Return a ServerRequest populated with superglobals:
  * $_GET
  * $_POST
  * $_COOKIE
  * $_FILES
  * $_SERVER
  *
  * @return ServerRequestInterface
  */
public static function fromGlobals()
{
    //.... skipped code

    $serverRequest = new ServerRequest($method, $uri, $headers, $body, $protocol, $_SERVER);

    return $serverRequest
        -&gt;withCookieParams($_COOKIE)
        -&gt;withQueryParams($_GET)
        -&gt;withParsedBody($_POST)
        -&gt;withUploadedFiles(self::normalizeFiles($_FILES));
}</pre><p>(<a title="ServerRequestInterface of Tag 1.4.2" href="https://github.com/guzzle/psr7/blob/1.4.2/src/ServerRequest.php#L166">ServerRequestInterface on Github</a>)</p>
<p>The other methods are to consume the same data:</p>
<ul>
<li>getServerParams</li>
<li>getCookieParams</li>
<li>getQueryParams</li>
<li>getParsedBody</li>
<li>getAttributes</li>
<li>getAttribute</li>
</ul>
<p>So we have “setter” and matching “getter” methods.</p>
<p><img data-attachment-id="922" data-permalink="https://dev98.de/2018/01/02/psr-7-standard-part-6-server-requests/psr-7-serverrequestinterface-png/" data-orig-file="https://i0.wp.com/dev98.de/wp-content/uploads/2018/01/PSR-7-ServerRequestInterface.png?fit=572%2C422&amp;ssl=1" data-orig-size="572,422" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="" data-image-description="" data-medium-file="https://i0.wp.com/dev98.de/wp-content/uploads/2018/01/PSR-7-ServerRequestInterface.png?fit=300%2C221&amp;ssl=1" data-large-file="https://i0.wp.com/dev98.de/wp-content/uploads/2018/01/PSR-7-ServerRequestInterface.png?fit=572%2C422&amp;ssl=1" class="alignnone size-full wp-image-922" src="https://i0.wp.com/dev98.de/wp-content/uploads/2018/01/PSR-7-ServerRequestInterface.png?resize=572%2C422&#038;ssl=1" width="572" height="422" data-recalc-dims="1" /></p>
<p>What’s up with the “getAttributes” and &#8220;getAttribute&#8221; methods? This methods are important for the next part of our blog series. The Middleware.</p>
]]></content:encoded>
							<wfw:commentRss>https://dev98.de/2018/01/02/psr-7-standard-part-6-server-requests/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">924</post-id>	</item>
		<item>
		<title>PSR-7 Standard  &#8211; Part 5  &#8211; HTTP Client</title>
		<link>https://dev98.de/2017/12/27/psr-7-standard-part-5-http-client/</link>
				<comments>https://dev98.de/2017/12/27/psr-7-standard-part-5-http-client/#respond</comments>
				<pubDate>Wed, 27 Dec 2017 09:00:30 +0000</pubDate>
		<dc:creator><![CDATA[Christian Münch]]></dc:creator>
				<category><![CDATA[General]]></category>
		<category><![CDATA[client]]></category>
		<category><![CDATA[HTTP]]></category>
		<category><![CDATA[PSR]]></category>

		<guid isPermaLink="false">https://dev98.de/?p=901</guid>
				<description><![CDATA[This post is part of series: Part 1: Overview Part 2: Request and URI Part 3: Response Part 4: File Uploads Part 5: HTTP-Client Part 6: Server Request Part 7: Middleware Part 8: Usage in a Magento module The fifth part of the PSR-7 series describes the HTTP Client. The HTTP client is tool which sends a request to a server and returns the response. Sadly PSR-7 does not contain an interface for the HTTP client. The Standard contains only the HTTP messages. The...<p class="read-more"><a class="btn btn-default" href="https://dev98.de/2017/12/27/psr-7-standard-part-5-http-client/"> Read More<span class="screen-reader-text">  Read More</span></a></p>]]></description>
								<content:encoded><![CDATA[<p>This post is part of series:</p>
<ul>
<li><a href="/2017/01/17/psr-7-standard-part1-overview/">Part 1: Overview</a></li>
<li><a href="/2017/07/03/psr-7-standard-part-2-request-and-uri/">Part 2: Request and URI</a></li>
<li><a href="/2017/10/19/psr-7-standard-part-3-response/">Part 3: Response</a></li>
<li><a href="/2017/11/25/psr-7-standard-part-4-file-uploads">Part 4: File Uploads</a></li>
<li><strong>Part 5: HTTP-Client</strong></li>
<li><a href="/2018/01/02/psr-7-standard-part-6-server-requests/">Part 6: Server Request</a></li>
<li>Part 7: Middleware</li>
<li>Part 8: Usage in a Magento module</li>
</ul>
<hr />
<p>The fifth part of the PSR-7 series describes the <strong>HTTP Client</strong>.</p>
<p>The HTTP client is tool which sends a request to a server and returns the response.</p>
<p>Sadly PSR-7 does not contain an interface for the HTTP client. The Standard contains only the HTTP messages. The client itself is part of the proposed <a title="PSR-18" href="https://github.com/php-fig/fig-standards/blob/master/proposed/http-client/http-client.md">PSR-18</a>.</p>
<p>PSR-18 is very small. It contains only an Interface with one method and some exception classes. The important part is the <code>sendRequest</code> method. It is easy as pie. A request has to be passed and the client should return a response or throw an <pre class="crayon-plain-tag">ClientException</pre> exception.</p><pre class="crayon-plain-tag">interface ClientInterface
{
    /**
     * Sends a PSR-7 request and returns a PSR-7 response. 
     * 
     * @param RequestInterface $request
     *
     * @return ResponseInterface
     *
     * @throws \Psr\Http\Client\ClientException If an error happens during processing the request.
     */
    public function sendRequest(RequestInterface $request): ResponseInterface;
}</pre><p>At the moment we cannot use PSR-18 in a production environment until it is accepted by the FIG. Fortunately there is an other project which tries to close the gap until the PSR-18 is accepted. The project is the father of the PSR-18. We talk about the HTTPPlug Project (former PHP-HTTP).</p>
<h2>HTTPPlug Project</h2>
<p>The project’s homepage is <a href="http://httplug.io/">http://httplug.io/</a>. The main idea is to decouple a PHP package/library from implementation by providing a HTTP client abstraction and some standard implementations.</p>
<p>It provides a Composer meta package. You don’t know what a Composer meta package is? Think of it as a kind of interface for packages.</p>
<p>This meta package can be added as requirements in your composer.json. Any compatible package can “<a href="https://getcomposer.org/doc/04-schema.md#provide">provide</a>” an implementation for the meta package.</p>
<p>If you need a HTTP Client Implementation in your project, you should relay on the meta package instead of an real implementation.</p>
<p>The implementation can be fulfilled in a project where the PHP library should be used. It is possible to pick any implementation from <a title="Composer Package List - Client Implementations" href="https://packagist.org/providers/php-http/client-implementation">a huge list</a> of existing implementations.</p>
<p><img data-attachment-id="900" data-permalink="https://dev98.de/2017/12/27/psr-7-standard-part-5-http-client/draggedimage-png-3/" data-orig-file="https://i2.wp.com/dev98.de/wp-content/uploads/2017/12/DraggedImage.png?fit=1161%2C818&amp;ssl=1" data-orig-size="1161,818" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="" data-image-description="" data-medium-file="https://i2.wp.com/dev98.de/wp-content/uploads/2017/12/DraggedImage.png?fit=300%2C211&amp;ssl=1" data-large-file="https://i2.wp.com/dev98.de/wp-content/uploads/2017/12/DraggedImage.png?fit=640%2C451&amp;ssl=1" class="alignnone size-full wp-image-900" src="https://i2.wp.com/dev98.de/wp-content/uploads/2017/12/DraggedImage.png?resize=640%2C451&#038;ssl=1" width="640" height="451" data-recalc-dims="1" /></p>
<h2>An Example Library</h2>
<p>First we need a <strong>composer.json</strong> which requires a client implementation. For testing purposes we can add a development requirement to add some example scripts to the library. The HTTP-Plug project comes with a small and handy <a href="http://php.net/manual/de/book.curl.php">CURL</a> based implementation which provides an implementation for the meta package. For the message implementation i.e. the Request, we make use of Guzzle&#8217;s PSR-7 implementation (see previous posts).</p>
<p><img data-attachment-id="899" data-permalink="https://dev98.de/2017/12/27/psr-7-standard-part-5-http-client/draggedimage-1-png-2/" data-orig-file="https://i2.wp.com/dev98.de/wp-content/uploads/2017/12/DraggedImage-1.png?fit=969%2C824&amp;ssl=1" data-orig-size="969,824" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="" data-image-description="" data-medium-file="https://i2.wp.com/dev98.de/wp-content/uploads/2017/12/DraggedImage-1.png?fit=300%2C255&amp;ssl=1" data-large-file="https://i2.wp.com/dev98.de/wp-content/uploads/2017/12/DraggedImage-1.png?fit=640%2C544&amp;ssl=1" class="alignnone size-full wp-image-899" src="https://i2.wp.com/dev98.de/wp-content/uploads/2017/12/DraggedImage-1.png?resize=640%2C544&#038;ssl=1" width="640" height="544" data-recalc-dims="1" /></p><pre class="crayon-plain-tag">{
  &quot;name&quot;: &quot;acme/my-super-php-library&quot;,
  &quot;require&quot;: {
    &quot;php-http/client-implementation&quot;: &quot;^1.0&quot;,
    &quot;guzzlehttp/psr7&quot;: &quot;^1.4&quot;
  },
  &quot;autoload&quot;: {
    &quot;psr-4&quot;: {
      &quot;Acme\\MyLibrary\\&quot;: &quot;src&quot;
    }
  },
  &quot;require-dev&quot;: {
    &quot;php-http/curl-client&quot;: &quot;^1.7&quot;
  }
}</pre><p>After a <pre class="crayon-plain-tag">composer install</pre>  we are ready to create a sample service which uses the HTTP client. Let’s try to fetch the XML feed from dev98.de.</p>
<p>We create a service class to fetch the XML feed. The service has a dependency to the HTTP Client interface. The file should be placed in the “src” sub-directory according to our PSR4 autoloading setting in composer.json file.</p><pre class="crayon-plain-tag">&lt;?php

namespace Acme\MyLibrary;

use GuzzleHttp\Psr7\Request;

class FetchXmlFeedService
{
    /**
     * @var \Http\Client\HttpClient
     */
    private $client;

    /**
     * ExampleService constructor.
     * @param \Http\Client\HttpClient $client
     */
    public function __construct(\Http\Client\HttpClient $client)
    {
        $this-&gt;client = $client;
    }

    /**
     * @return \SimpleXMLElement
     * @throws \Exception
     */
    public function fetch(): \SimpleXMLElement
    {
        $request = (new Request('GET', 'https://dev98.de/feed/'))
            -&gt;withHeader('Accept', 'application/xml');

        $response = $this-&gt;client-&gt;sendRequest($request);

        if ($response-&gt;getStatusCode() !== 200) {
            throw new \Exception('Could not fetch XML feed');
        }

        return simplexml_load_string($response-&gt;getBody()-&gt;getContents());
    }
}</pre><p>The service does not rely on a real implementation. The <pre class="crayon-plain-tag">\Http\Client\HttpClient</pre>  is only an interface.</p>
<p>Now we create a sample script which calls our service in the sub-directory “examples&#8221;.</p><pre class="crayon-plain-tag">&lt;?php

require_once __DIR__ . '/../vendor/autoload.php';

$httpClient = new \Http\Client\Curl\Client();
$service = new \Acme\MyLibrary\FetchXmlFeedService($httpClient);
$xmlData = $service-&gt;fetch();

foreach ($xmlData-&gt;channel-&gt;item as $item) {
    echo (string) $item-&gt;title . "\n";
}</pre><p>That’s our simple library with an example script. Testing this library is also not a big deal. We can easily mock the Interface.</p>
<h2>Use the Library</h2>
<p>If we want to use the library in a real project, we need to add the library in our project’s composer.json file. Then we add an implementation for the http client. This must not be the same as the development requirements in our library. This is a big advantage. If our PHP framework comes with an implementation which fits, we can re-use it.</p>
<p>The complete source of the blog post is available on Github: <a href="https://github.com/cmuench/psr7-example-library">https://github.com/cmuench/psr7-example-library</a></p>
<p>The next blog post in this series describes the Server-Request.</p>
]]></content:encoded>
							<wfw:commentRss>https://dev98.de/2017/12/27/psr-7-standard-part-5-http-client/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">901</post-id>	</item>
		<item>
		<title>Chrome 63 vs. dev domains</title>
		<link>https://dev98.de/2017/12/08/chrome-63-vs-dev-domains/</link>
				<comments>https://dev98.de/2017/12/08/chrome-63-vs-dev-domains/#respond</comments>
				<pubDate>Fri, 08 Dec 2017 09:15:24 +0000</pubDate>
		<dc:creator><![CDATA[Matthias Walter]]></dc:creator>
				<category><![CDATA[General]]></category>

		<guid isPermaLink="false">https://dev98.de/?p=885</guid>
				<description><![CDATA[With the recent update to version 63 for Chrome they introduced a feature, that redirects all [crayon-5e244ec5ca8bb745724310-i/]  calls from HTTP to HTTPS. If you are using [crayon-5e244ec5ca8bf846684449-i/]  domains to access your development machine, this behaviour is probably not what you want for all your local urls. Configuring dnsmasq At netz98 we are using dnsmasq to redirect all [crayon-5e244ec5ca8c1888939837-i/]  calls to our localhost. dnsmasq has a setting where you can easily change this to another domain like [crayon-5e244ec5ca8c2238732634-i/] . First of locate...<p class="read-more"><a class="btn btn-default" href="https://dev98.de/2017/12/08/chrome-63-vs-dev-domains/"> Read More<span class="screen-reader-text">  Read More</span></a></p>]]></description>
								<content:encoded><![CDATA[<p>With the recent update to version 63 for Chrome they introduced a feature, that redirects all <pre class="crayon-plain-tag">*.dev</pre>  calls from HTTP to HTTPS.</p>
<p>If you are using <pre class="crayon-plain-tag">*.dev</pre>  domains to access your development machine, this behaviour is probably not what you want for all your local urls.</p>
<h2>Configuring dnsmasq</h2>
<p>At netz98 we are using dnsmasq to redirect all <pre class="crayon-plain-tag">*.dev</pre>  calls to our localhost.</p>
<p>dnsmasq has a setting where you can easily change this to another domain like <pre class="crayon-plain-tag">*.localhost</pre> .</p>
<p>First of locate the config file for dnsmasq. If you have installed it using brew you will probably find it under <pre class="crayon-plain-tag">/usr/local/etc/dnsmasq.conf</pre> .</p>
<p>Open the file in an editor of your choice and look for the following line:</p><pre class="crayon-plain-tag">address=/dev/127.0.0.1</pre><p>And change it to:</p><pre class="crayon-plain-tag">address=/localhost/127.0.0.1</pre><p>If you cannot find a line setting the address like shown above, just add a new line with the setting.</p>
<p>To restart dnsmasq you can use</p><pre class="crayon-plain-tag">brew services restart dnsmasq</pre><p></p>
<h2>Configuring apache / nginx</h2>
<p>Depending on your choice of setup you might be using an nginx or apache setup.</p>
<p>You most likely have some virtual-hosts or server settings that might need to be adjusted to the new domain.</p>
<p>This could look something like this for nginx.</p><pre class="crayon-plain-tag">server {
  listen 80;

  server_name shop.dev;

  // ....
}</pre><p>Locate the server_name setting and any other occurences of your <pre class="crayon-plain-tag">*.dev</pre>  domain and change it to <pre class="crayon-plain-tag">.localhost</pre></p>
<p>Do not forget to change your Magento1 or Magento2 Urls in the core_config_data table.</p>
<h2><strong>MacOS Nameserver</strong></h2>
<p>For Firefox and Safari and a working <pre class="crayon-plain-tag">ping foo.bar.localhost</pre> , you also have to add a setting for that.</p>
<p>Create the file <pre class="crayon-plain-tag">/etc/resolver/localhost</pre>  with the following content:</p><pre class="crayon-plain-tag">nameserver 127.0.0.1</pre><p>After doing so, you need to restart the DNS Resolver and flush caches.<br />
I am on the latest MacOS 10.13 so I had to run the following command:</p><pre class="crayon-plain-tag">sudo killall -HUP mDNSResponder; sudo killall mDNSResponderHelper; sudo dscacheutil -flushcache</pre><p>If you are running a different MacOS version, you can find a great blog post over at Dreamhost where they list the commands for each MacOS version: <a href="https://help.dreamhost.com/hc/en-us/articles/214981288-Flushing-your-DNS-cache-in-Mac-OS-X-and-Linux">https://help.dreamhost.com/hc/en-us/articles/214981288-Flushing-your-DNS-cache-in-Mac-OS-X-and-Linux</a></p>
<p><strong>UPDATE:</strong><br />
You might have to do a reboot of your machine so that the resolver works.</p>
<p><strong>UPDATE 2:</strong><br />
Firefox and Safari require the above mentioned resolver to work.</p>
<p>If you got anything to add or there even is a better solution feel free to leave a comment below.</p>
]]></content:encoded>
							<wfw:commentRss>https://dev98.de/2017/12/08/chrome-63-vs-dev-domains/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">885</post-id>	</item>
		<item>
		<title>PSR-7 Standard  &#8211; Part 4 &#8211; File Uploads</title>
		<link>https://dev98.de/2017/11/25/psr-7-standard-part-4-file-uploads/</link>
				<comments>https://dev98.de/2017/11/25/psr-7-standard-part-4-file-uploads/#respond</comments>
				<pubDate>Sat, 25 Nov 2017 13:22:17 +0000</pubDate>
		<dc:creator><![CDATA[Christian Münch]]></dc:creator>
				<category><![CDATA[General]]></category>
		<category><![CDATA[HTTP]]></category>
		<category><![CDATA[PSR]]></category>
		<category><![CDATA[upload]]></category>

		<guid isPermaLink="false">https://dev98.de/?p=867</guid>
				<description><![CDATA[This post is part of series: Part 1: Overview Part 2: Request and URI Part 3: Response Part 4: File Uploads Part 5: HTTP-Client Part 6: Server Request Part 7: Middleware Part 8: Usage in a Magento module After we learned what a Request and a Response are, let’s now look how we can send files to the server. Then have a look on how we can process them with Guzzle on the server side. Client Side Script As you can see in the...<p class="read-more"><a class="btn btn-default" href="https://dev98.de/2017/11/25/psr-7-standard-part-4-file-uploads/"> Read More<span class="screen-reader-text">  Read More</span></a></p>]]></description>
								<content:encoded><![CDATA[<p>This post is part of series:</p>
<ul>
<li><a href="https://dev98.de/2017/01/17/psr-7-standard-part1-overview/">Part 1: Overview</a></li>
<li><a href="https://dev98.de/2017/07/03/psr-7-standard-part-2-request-and-uri/">Part 2: Request and URI</a></li>
<li><a href="/2017/10/19/psr-7-standard-part-3-response/">Part 3: Response</a></li>
<li><strong>Part 4: File Uploads</strong></li>
<li><a href="/2017/12/27/psr-7-standard-part-5-http-client/">Part 5: HTTP-Client</a></li>
<li><a href="/2018/01/02/psr-7-standard-part-6-server-requests/">Part 6: Server Request</a></li>
<li>Part 7: Middleware</li>
<li>Part 8: Usage in a Magento module</li>
</ul>
<hr />
<p>After we learned what a Request and a Response are, let’s now look how we can send files to the server. Then have a look on how we can process them with Guzzle on the server side.</p>
<h2>Client Side Script</h2>
<p>As you can see in the diagram, a file upload is also handled as stream.</p>
<p><img data-attachment-id="865" data-permalink="https://dev98.de/2017/11/25/psr-7-standard-part-4-file-uploads/psr7_uploaded_file-png/" data-orig-file="https://i0.wp.com/dev98.de/wp-content/uploads/2017/11/psr7_uploaded_file.png?fit=3375%2C1784&amp;ssl=1" data-orig-size="3375,1784" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="" data-image-description="" data-medium-file="https://i0.wp.com/dev98.de/wp-content/uploads/2017/11/psr7_uploaded_file.png?fit=300%2C159&amp;ssl=1" data-large-file="https://i0.wp.com/dev98.de/wp-content/uploads/2017/11/psr7_uploaded_file.png?fit=640%2C338&amp;ssl=1" class="alignnone size-full wp-image-865" src="https://i0.wp.com/dev98.de/wp-content/uploads/2017/11/psr7_uploaded_file.png?resize=640%2C338&#038;ssl=1" width="640" height="338" data-recalc-dims="1" /></p>
<p>First we create script “file_upload.php” with this content which initializes the autoloader and creates a sample file for the upload test.</p><pre class="crayon-plain-tag">&lt;?php
require_once 'vendor/autoload.php';
  
// create a test file
file_put_contents('foo.txt', '"Foo" is the content of the file');</pre><p>After we have a text file, we can create our stream with the Guzzle PSR-7 component. Please add the code to the existing file.</p><pre class="crayon-plain-tag">// put test file into multipart stream
$multipart = new \GuzzleHttp\Psr7\MultipartStream([
    [
        'name' =&gt; 'upload_file',
        'contents' =&gt; fopen('foo.txt', 'r')
    ],
]);</pre><p>The <code>MultipartStream</code> gives us the ability to send more than once file to the server. As last part of the script we need to create a Request to send the <code>MultipartStream</code> to the server.</p><pre class="crayon-plain-tag">$request = new \GuzzleHttp\Psr7\Request('POST', 'http://127.0.0.1:8080');
$request = $request-&gt;withBody($multipart);

$client = new \GuzzleHttp\Client();
$response = $client-&gt;send($request);
echo $response-&gt;getBody();</pre><p></p>
<h2>Server Side Script</h2>
<p>Please create the script “server_file.php” to receive the files.</p><pre class="crayon-plain-tag">&lt;?php

require_once __DIR__ . '/vendor/autoload.php';

$request = \GuzzleHttp\Psr7\ServerRequest::fromGlobals();
$files = $request-&gt;getUploadedFiles();

$response = new \GuzzleHttp\Psr7\Response();
$response = $response-&gt;withStatus(200, 'OK');

$uploadedFiles = $request-&gt;getUploadedFiles();

$uploadedFileInfos = [];
foreach ($uploadedFiles as $uploadedFile) {
    /** @var $uploadedFile \GuzzleHttp\Psr7\UploadedFile */
    $uploadedFileInfos[] = [
        'file_name' =&gt; $uploadedFile-&gt;getClientFilename(),
        'mime_type' =&gt; $uploadedFile-&gt;getClientMediaType(),
        'size'      =&gt; $uploadedFile-&gt;getSize(),
        'content'   =&gt; (string) $uploadedFile-&gt;getStream()
    ];
}

$response = $response-&gt;withBody(
    \GuzzleHttp\Psr7\stream_for(print_r($uploadedFileInfos))
);

echo \GuzzleHttp\Psr7\str($response);</pre><p>The script is very simple. It creates a <code>ServerRequest</code> (we talk about this in a future blog post). The <code>ServerRequest</code> can handle the <code>MultipartStream</code> and return the files with the handy method method <code>getUploadedFiles</code>. This methods is now a standard to get all data of the uploaded files. If you know how files are handled without PSR-7 you know that this is a really enhancement.</p>
<p>For debugging we collect all data of the uploaded files and return them back as response to the client.</p>
<h2>Test the Upload</h2>
<p>Run the server in console:</p><pre class="crayon-plain-tag">php -S 127.0.0.1:8080 server_file.php</pre><p>Run the client script in a second console:</p><pre class="crayon-plain-tag">php file_upload.php</pre><p>If you did everything correct you should now see the result of the server script:</p><pre class="crayon-plain-tag">HTTP/1.1 200 OK

Array
(
    [0] =&gt; Array
        (
            [file_name] =&gt; foo.txt
            [mime_type] =&gt; text/plain
            [size] =&gt; 32
            [content] =&gt; "Foo" is the content of the file
        )

)</pre><p>&nbsp;</p>
<p>That’s it. The next blog post will give you some inside into the HTTP Client.</p>
]]></content:encoded>
							<wfw:commentRss>https://dev98.de/2017/11/25/psr-7-standard-part-4-file-uploads/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">867</post-id>	</item>
		<item>
		<title>Run Mailhog in Docker and use it in PHP</title>
		<link>https://dev98.de/2017/11/20/run-mailhog-in-docker-and-use-it-in-php/</link>
				<comments>https://dev98.de/2017/11/20/run-mailhog-in-docker-and-use-it-in-php/#respond</comments>
				<pubDate>Mon, 20 Nov 2017 10:45:31 +0000</pubDate>
		<dc:creator><![CDATA[Christian Münch]]></dc:creator>
				<category><![CDATA[General]]></category>
		<category><![CDATA[mailhog]]></category>
		<category><![CDATA[PHP]]></category>
		<category><![CDATA[smtp]]></category>

		<guid isPermaLink="false">https://dev98.de/?p=849</guid>
				<description><![CDATA[This post describes how you can install and configure Mailhog as SMTP Server for your local PHP development environment. This is useful to catch all outgoing emails. A running PHP and Docker environment is required to follow the instructions. Install Mailhog On my local machine, I have docker-compose.yml file which contains a lot of services (e.g MySQL, Elastic, Redis) which I use during the daily development. For our mailhog example we need only one service. Please create a docker-compose.yml with...<p class="read-more"><a class="btn btn-default" href="https://dev98.de/2017/11/20/run-mailhog-in-docker-and-use-it-in-php/"> Read More<span class="screen-reader-text">  Read More</span></a></p>]]></description>
								<content:encoded><![CDATA[<p>This post describes how you can install and configure Mailhog as SMTP Server for your local PHP development environment. This is useful to catch all outgoing emails.</p>
<p>A running PHP and Docker environment is required to follow the instructions.</p>
<h2>Install Mailhog</h2>
<p>On my local machine, I have <strong>docker-compose.yml</strong> file which contains a lot of services (e.g MySQL, Elastic, Redis) which I use during the daily development.</p>
<p>For our mailhog example we need only one service. Please create a docker-compose.yml with this content:</p><pre class="crayon-plain-tag">version: '2'
services:
    mailhog:
        container_name: mailhog
        image: mailhog/mailhog
        restart: always
        ports:
            - 1025:1025
            - 8025:8025</pre><p>Run <code>docker-compose up -d mailhog</code> to create and start the container. If the mailhog image does not exist, Docker will start to download the image from official <a title="Official Mailhog Docker Image" href="https://hub.docker.com/r/mailhog/mailhog/">Docker-Hub</a>.</p>
<p>Verify if everything is up and running.</p><pre class="crayon-plain-tag">docker-compose ps
Name      Command             State    Ports
-------------------------------------------------------------------------------------
mailhog   MailHog             Up       0.0.0.0:1025-&gt;1025/tcp, 0.0.0.0:8025-&gt;8025/tcp</pre><p>No you can use the TCP Port 1025 for sending email over SMTP protocol. The Port 8025 contains the Web-UI.</p>
<h2>Configure PHP</h2>
<p>Out goal is that PHP’s intern command “mail” uses our freshly installed Mailhog server. To effect this, we need to set the “sendmail_path” setting.</p>
<p>Please modify your php.ini file and set the following directive:</p><pre class="crayon-plain-tag">sendmail_path = docker exec -i mailhog sendmail -S localhost:1025</pre><p>From now, every “mail” command call uses the docker container with the name “mailhog” to send any email.</p>
<p>We can test this with a simple PHP CLI call:</p><pre class="crayon-plain-tag">php -r 'mail("foo@example.com", "test", time(), "From: Mailhog &lt;mailhog@example.com&gt;");'</pre><p>We should now be able to see the arrived message in the Web-UI. Open your browser with the address “http://localhost:8025”.</p>
<p><img data-attachment-id="848" data-permalink="https://dev98.de/2017/11/20/run-mailhog-in-docker-and-use-it-in-php/draggedimage-png-2/" data-orig-file="https://i1.wp.com/dev98.de/wp-content/uploads/2017/11/DraggedImage.png?fit=881%2C452&amp;ssl=1" data-orig-size="881,452" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Mailhog UI" data-image-description="" data-medium-file="https://i1.wp.com/dev98.de/wp-content/uploads/2017/11/DraggedImage.png?fit=300%2C154&amp;ssl=1" data-large-file="https://i1.wp.com/dev98.de/wp-content/uploads/2017/11/DraggedImage.png?fit=640%2C328&amp;ssl=1" class="alignnone size-full wp-image-848" src="https://i1.wp.com/dev98.de/wp-content/uploads/2017/11/DraggedImage.png?resize=640%2C328&#038;ssl=1" width="640" height="328" data-recalc-dims="1" /></p>
]]></content:encoded>
							<wfw:commentRss>https://dev98.de/2017/11/20/run-mailhog-in-docker-and-use-it-in-php/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">849</post-id>	</item>
		<item>
		<title>Sequence of Magento 2 Install / Upgrade / Recurring scripts</title>
		<link>https://dev98.de/2017/11/13/sequence-of-magento-2-install-upgrade-recurring-scripts/</link>
				<comments>https://dev98.de/2017/11/13/sequence-of-magento-2-install-upgrade-recurring-scripts/#respond</comments>
				<pubDate>Mon, 13 Nov 2017 10:41:34 +0000</pubDate>
		<dc:creator><![CDATA[Alexander Dite]]></dc:creator>
				<category><![CDATA[Magento 2]]></category>
		<category><![CDATA[install]]></category>
		<category><![CDATA[magento2]]></category>
		<category><![CDATA[recurring]]></category>
		<category><![CDATA[script]]></category>
		<category><![CDATA[setup]]></category>
		<category><![CDATA[upgrade]]></category>

		<guid isPermaLink="false">https://dev98.de/?p=836</guid>
				<description><![CDATA[Preamble In one of my last tasks I had to write an upgrade script in which an assignment of a newly created frontend theme to some of the stores should be implemented. The following code-part describes what I did here: [crayon-5e244ec5cae37299128156/] As I already had an InstallData Script in the module and it already has run on some dev machines and staging systems, I put the following code to the newly created UpgradeData script. The problem The code in the...<p class="read-more"><a class="btn btn-default" href="https://dev98.de/2017/11/13/sequence-of-magento-2-install-upgrade-recurring-scripts/"> Read More<span class="screen-reader-text">  Read More</span></a></p>]]></description>
								<content:encoded><![CDATA[<h2>Preamble</h2>
<p>In one of my last tasks I had to write an upgrade script in which an assignment of a newly created frontend theme to some of the stores should be implemented.</p>
<p>The following code-part describes what I did here:</p><pre class="crayon-plain-tag">/**
 *
 */
protected function assignNewThemeToSelectedStores()
{
    $storeIdsForNewTheme = [];

    foreach ($this-&gt;storesCodesWithNewTheme as $storeCode) {
        $storeIdsForNewTheme[] = $this-&gt;storeRepository-&gt;get($storeCode)-&gt;getId();
    }

    /** @var \Magento\Theme\Model\ResourceModel\Theme\Collection $themes */
    $themes = $this-&gt;themeCollectionFactory-&gt;create()-&gt;loadRegisteredThemes();
    /**
     * @var \Magento\Theme\Model\Theme $theme
     */
    foreach ($themes as $theme) {
       if ($theme-&gt;getCode() === 'Mynewly/createdtheme') {
       $this-&gt;themeConfig-&gt;assignToStore(
           $theme,
           $storeIdsForNewTheme
       );
       }
    }
}</pre><p>As I already had an InstallData Script in the module and it already has run on some dev machines and staging systems, I put the following code to the newly created UpgradeData script.</p>
<h2>The problem</h2>
<p>The code in the upgrade script did not take any effect after running <strong>php bin/magento setup:upgrade</strong>. I found out that I could force it to take effect only after deleting the module entry from <strong>setup_module</strong> table an re-running <strong>setup:upgrade</strong> command.</p>
<h2>The reason</h2>
<p>Debugging of the <strong>setup:upgrade</strong> command revealed the fact, that at the moment of the first execution of my UpgradeData script, the new theme was not registered in the &#8220;<strong>theme</strong>&#8221; Magento DB table. It looked strange for me, because I&#8217;ve added a dependency to &#8220;Magento_Theme&#8221; module in my module.xml, as I obviously relied on this module&#8217;s code and data.</p>
<p>I then found out, that the registration of newly added themes is implemented in the following script:</p><pre class="crayon-plain-tag">vendor/magento/module-theme/Setup/RecurringData.php</pre><p>After debugging and analyzing the <strong>setup:upgrade</strong> command code, I came to the following result: in Magento the Setup Scripts are executed in the following order:</p>
<ul>
<li>InstallSchema &amp; UpgradeSchema</li>
<li>Recurring (Schema)</li>
<li>InstallData &amp; UpgradeData</li>
<li>RecurringData</li>
</ul>
<p>In this scopes the dependencies of the modules affect the sequence of the script execution, but if your module&#8217;s script depends on the code which is executed in a script of another module in a later scope than the scope of your script, your code will not work.</p>
<h2>The solution</h2>
<p>As my script depends on the latest scope &#8220;<strong>RecurringData</strong>&#8221; I had no choice than to put my code also in a &#8220;<strong>RecurringData</strong>&#8221; script. As recurring means it is executed on each setup:upgrade run, I made some checks in my script, in order to execute some performance critical tasks only if the right theme isn&#8217;t already set for the relevant stores.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content:encoded>
							<wfw:commentRss>https://dev98.de/2017/11/13/sequence-of-magento-2-install-upgrade-recurring-scripts/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">836</post-id>	</item>
	</channel>
</rss>
